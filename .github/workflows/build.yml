name: Build R36S ARM64 (glibc compatible)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v4

      - name: Enable ARM64
        uses: docker/setup-qemu-action@v3

      - name: Build in ARM64 Ubuntu 20.04
        run: |
          docker run --rm --platform linux/arm64 \
            -v "$PWD:/work" -w /work \
            ubuntu:20.04 /bin/bash -lc "
              set -e
              apt update
              apt install -y \
                build-essential clang cmake git \
                libgl1-mesa-dev libegl1-mesa-dev \
                libdrm-dev libgbm-dev libudev-dev \
                zlib1g-dev libx11-dev

              # dotnet
              curl -fsSL https://dot.net/v1/dotnet-install.sh | bash
              export PATH=\$HOME/.dotnet:\$PATH

              dotnet publish -c Release \
                -r linux-arm64 \
                --self-contained true \
                /p:PublishAot=true \
                /p:InvariantGlobalization=true
            "

      - name: Upload R36S binary
        uses: actions/upload-artifact@v4
        with:
          name: R36S-glibc228
          path: bin/Release/net8.0/linux-arm64/native/R36S
